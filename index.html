<script>
let hasCalculated = false;

function parseValOrNaN(id) {
  const raw = document.getElementById(id).value.trim().replace(',', '.');
  return raw === '' ? NaN : parseFloat(raw);
}
function fmt1(x) {
  if (isNaN(x)) return '–';
  return x.toFixed(1);
}
function setLocked(id, locked) {
  const el = document.getElementById(id);
  el.readOnly = locked;
  el.classList.remove('state-edit', 'state-locked');
  el.classList.add(locked ? 'state-locked' : 'state-edit');
}

// 1) RFL / Block : si l’un change, on vide l’autre (sauf texte info)
['rfl','block'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', () => {
    const otherId = id === 'rfl' ? 'block' : 'rfl';
    const otherEl = document.getElementById(otherId);
    if (el.value !== '' && el.value !== 'Go to Calcul') {
      otherEl.value = '';
      otherEl.readOnly = false;
    }
  });
});

// 2) Gérer les trois cases orange (ZFW, RFL, Block) et "Go to Calcul"
const orangeIds = ['zfw', 'rfl', 'block'];

orangeIds.forEach(id => {
  const el = document.getElementById(id);

  el.addEventListener('focus', () => {
    // si ce champ contient déjà une vraie valeur, on ne touche pas
    if (el.value !== '' && el.value !== 'Go to Calcul') return;

    // compter les autres cases orange déjà renseignées (hors "Go to Calcul")
    let filledCount = 0;
    orangeIds.forEach(oid => {
      if (oid === id) return; // on ne compte pas celle qu'on focus
      const v = document.getElementById(oid).value;
      if (v !== '' && v !== 'Go to Calcul') filledCount++;
    });

    // si deux autres cases sont déjà remplies et celle-ci est vide -> "Go to Calcul"
    if (filledCount >= 2 && (el.value === '' || el.value === 'Go to Calcul')) {
      el.value = 'Go to Calcul';
      el.readOnly = true;
    }
  });
});

// 3) si ZFW change, invalider RFL/Block/résultats uniquement après un calcul
document.getElementById('zfw').addEventListener('input', () => {
  if (!hasCalculated) return;
  document.getElementById('rfl').value   = '';
  document.getElementById('rfl').readOnly   = false;
  document.getElementById('block').value = '';
  document.getElementById('block').readOnly = false;
  document.getElementById('mlw').textContent  = '–';
  document.getElementById('mtow').textContent = '–';
  document.getElementById('trip').textContent = '–';
});

document.getElementById('btnCalc').addEventListener('click', function () {
  const zfw   = parseValOrNaN('zfw');
  const k     = parseValOrNaN('k');
  const taxi  = parseValOrNaN('taxi');
  let   rfl   = parseValOrNaN('rfl');
  let   block = parseValOrNaN('block');

  if (isNaN(zfw) || isNaN(k) || isNaN(taxi)) {
    alert('Renseigne au minimum ZFW, K et Taxi, puis soit RFL soit Block.');
    return;
  }

  hasCalculated = true;

  setLocked('k', true);
  setLocked('taxi', true);

  if (!isNaN(rfl)) {
    const law  = zfw + rfl;
    const tow  = law * k;
    const trip = tow - law;

    if (isNaN(block)) {
      block = taxi + trip + rfl;
      document.getElementById('block').value = block.toFixed(1);
    }

    document.getElementById('rfl').value = rfl.toFixed(1);
    document.getElementById('mlw').textContent  = fmt1(law);
    document.getElementById('mtow').textContent = fmt1(tow);
    document.getElementById('trip').textContent = fmt1(trip);
    return;
  }

  if (isNaN(rfl) && !isNaN(block)) {
    const rflSolved = (block - taxi - zfw * (k - 1)) / k;
    rfl = rflSolved;
    document.getElementById('rfl').value = rfl.toFixed(1);

    const law  = zfw + rfl;
    const tow  = law * k;
    const trip = tow - law;

    document.getElementById('mlw').textContent  = fmt1(law);
    document.getElementById('mtow').textContent = fmt1(tow);
    document.getElementById('trip').textContent = fmt1(trip);
    return;
  }

  alert('Renseigne soit RFL, soit Block (au moins l’un des deux).');
});

document.getElementById('btnReset').addEventListener('click', function () {
  hasCalculated = false;

  ['zfw','k','taxi','rfl','block'].forEach(id => {
    const el = document.getElementById(id);
    el.value = '';
    el.readOnly = false;
  });

  document.getElementById('zfw').className   = 'state-adjust';
  document.getElementById('rfl').className   = 'state-adjust';
  document.getElementById('block').className = 'state-adjust';
  document.getElementById('k').className     = 'state-edit';
  document.getElementById('taxi').className  = 'state-edit';

  ['mlw','mtow','trip'].forEach(id => {
    document.getElementById(id).textContent = '–';
  });
});

// service worker inchangé
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .catch(err => console.log('SW registration failed', err));
  });
}
</script>
