<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Flight Fuel Utils</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Icône & PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#101018">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background-color: #101018;
      color: #f7f7fb;
    }
    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 24px 18px 44px;
    }
    h1 {
      font-size: 24px;
      margin: 0 0 18px;
      text-align: center;
      font-weight: 700;
    }
    .group-title {
      margin-top: 20px;
      margin-bottom: 8px;
      font-size: 16px;
      opacity: 0.9;
    }
    label {
      font-size: 15px;
      opacity: 0.95;
    }
    .row {
      display: flex;
      flex-direction: column;
      margin-bottom: 14px;
    }

    input {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #3a3a48;
      background-color: #171725;
      color: #ffffff;
      font-size: 18px;
      font-weight: 600;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }
    input::placeholder {
      color: #7f7f9a;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(10,132,255,0.35);
    }

    /* bleu = entrées K & Taxi à figer après calcul */
    .state-edit {
      border-color: #0a84ff;
    }
    /* jaune = variables d'ajustement (ZFW, RFL, Block) */
    .state-adjust {
      border-color: #f5c445;
      background-color: #252020;
    }
    /* vert = K & Taxi verrouillés après calcul */
    .state-locked {
      border-color: #2ecc71;
      background-color: #16241b;
    }
    /* vert clair = valeurs de résultat */
    .state-result-value {
      color: #7fffb0;
    }

    /* champs impactés par une limitation */
    .state-limited {
      border-color: #ff9f1a !important;
      background-color: #2a1e08 !important;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .buttons {
      display: flex;
      gap: 12px;
      margin-top: 14px;
      margin-bottom: 20px;
    }
    button {
      flex: 1;
      padding: 12px 0;
      border-radius: 12px;
      border: none;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
    }
    #btnCalc {
      background-color: #0a84ff;
      color: #ffffff;
    }
    #btnReset {
      background-color: #2e2e3c;
      color: #ffffff;
    }

    .results {
      margin-top: 10px;
      padding: 14px 14px 12px;
      border-radius: 14px;
      background-color: #181828;
      border: 1px solid #3b3b4f;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 18px;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .result-label {
      opacity: 0.9;
    }
    .result-value {
      font-weight: 700;
      color: #ffffff;
    }

    /* Champs de limitation TOW / LAW visibles */
    .limit-input {
      max-width: 140px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 2px solid #ff9f1a;
      background-color: #2a1e08;
      color: #ffffff;
      font-size: 15px;
      font-weight: 700;
    }
    .limit-input::placeholder {
      color: #ffcf80;
      font-weight: 500;
    }

    .footer {
      margin-top: 22px;
      font-size: 13px;
      text-align: center;
      opacity: 0.7;
      line-height: 1.4;
    }

    @media (max-width: 480px) {
      .app {
        padding: 20px 14px 32px;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .result-row {
        font-size: 17px;
      }
      input {
        font-size: 18px; /* >=16px pour limiter le zoom auto iOS [web:283][web:292] */
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Flight Fuel Utils</h1>

  <div class="group-title">Entrées (tonnes)</div>
  <div class="row">
    <label for="zfw">ZFW (T)</label>
    <input id="zfw" class="state-adjust" type="number" step="0.1" inputmode="decimal" placeholder="ex. 180.5">
  </div>

  <div class="row">
    <label for="k">K (coef &gt; 1, 3 décimales)</label>
    <input id="k" class="state-edit" type="number" step="0.001" inputmode="decimal" placeholder="ex. 1.037">
  </div>

  <div class="grid-2">
    <div class="row">
      <label for="taxi">Taxi (T)</label>
      <input id="taxi" class="state-edit" type="number" step="0.1" inputmode="decimal" placeholder="ex. 0.4">
    </div>
    <div class="row">
      <label for="rfl">Remaining Fuel at Landing (T)</label>
      <input id="rfl" class="state-adjust" type="number" step="0.1" inputmode="decimal" placeholder="ex. 7.0">
    </div>
  </div>

  <div class="row">
    <label for="block">Block Fuel (T)</label>
    <input id="block" class="state-adjust" type="number" step="0.1" inputmode="decimal" placeholder="ex. 25.3">
  </div>

  <div class="buttons">
    <button id="btnCalc">Calcul</button>
    <button id="btnReset">Reset</button>
  </div>

  <div class="results" id="resultsBox">
    <!-- TOW + limitation -->
    <div class="result-row">
      <div class="result-label">TOW (T)</div>
      <div class="result-value state-result-value" id="mtow">–</div>
      <input id="towLimit" class="limit-input" type="number" step="0.1"
             inputmode="decimal" placeholder="Lim TOW (T)">
    </div>

    <!-- Trip -->
    <div class="result-row">
      <div class="result-label">Trip Fuel (T)</div>
      <div class="result-value state-result-value" id="trip">–</div>
    </div>

    <!-- LAW + limitation -->
    <div class="result-row">
      <div class="result-label">LAW (T)</div>
      <div class="result-value state-result-value" id="mlw">–</div>
      <input id="lawLimit" class="limit-input" type="number" step="0.1"
             inputmode="decimal" placeholder="Lim LAW (T)">
    </div>
  </div>

  <div class="footer">
    ZFW + RFL = LAW · LAW × K = TOW · Trip = TOW − LAW · Block = Taxi + Trip + RFL
  </div>
</div>

<script>
let hasCalculated = false;

function parseValOrNaN(id) {
  const raw = document.getElementById(id).value.trim().replace(',', '.');
  return raw === '' ? NaN : parseFloat(raw);
}
function fmt1(x) {
  if (isNaN(x)) return '–';
  return x.toFixed(1);
}
function setLocked(id, locked) {
  const el = document.getElementById(id);
  el.readOnly = locked;
  el.classList.remove('state-edit', 'state-locked');
  el.classList.add(locked ? 'state-locked' : 'state-edit');
}

const zfwEl     = document.getElementById('zfw');
const kEl       = document.getElementById('k');
const taxiEl    = document.getElementById('taxi');
const rflEl     = document.getElementById('rfl');
const blockEl   = document.getElementById('block');
const mtowEl    = document.getElementById('mtow');
const mlwEl     = document.getElementById('mlw');
const tripEl    = document.getElementById('trip');
const towLimEl  = document.getElementById('towLimit');
const lawLimEl  = document.getElementById('lawLimit');

function clearResults() {
  mtowEl.textContent = '–';
  mlwEl.textContent  = '–';
  tripEl.textContent = '–';
}

function clearLimitsAndDerived() {
  towLimEl.value = '';
  lawLimEl.value = '';
  zfwEl.value   = '';
  blockEl.value = '';
  zfwEl.classList.remove('state-limited');
  blockEl.classList.remove('state-limited');
  clearResults();
  hasCalculated = false;
}

// Effacer limites + dérivés quand on vide une limite
function handleLimitInputClear(el) {
  const val = el.value.trim();
  if (val === '') {
    clearLimitsAndDerived();
  }
}

// RFL / Block : si l’un change, on efface l’autre ET les limites (dès le premier caractère) [web:271][web:279]
['rfl','block'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', () => {
    const otherId = id === 'rfl' ? 'block' : 'rfl';
    const otherEl = document.getElementById(otherId);
    otherEl.value = '';
    towLimEl.value = '';
    lawLimEl.value = '';
    zfwEl.classList.remove('state-limited');
    blockEl.classList.remove('state-limited');
  });
});

// ZFW : après un calcul, toute modification invalide RFL, Block, résultats et limites
zfwEl.addEventListener('input', () => {
  if (!hasCalculated) return;
  rflEl.value   = '';
  blockEl.value = '';
  clearLimitsAndDerived();
});

// K / Taxi / RFL / Block : si on change après une limitation, on efface les limites visuelles
[kEl, taxiEl, rflEl, blockEl].forEach(el => {
  el.addEventListener('input', () => {
    towLimEl.value = '';
    lawLimEl.value = '';
    zfwEl.classList.remove('state-limited');
    blockEl.classList.remove('state-limited');
  });
});

document.getElementById('btnCalc').addEventListener('click', function () {
  const zfw   = parseValOrNaN('zfw');
  const k     = parseValOrNaN('k');
  const taxi  = parseValOrNaN('taxi');
  let   rfl   = parseValOrNaN('rfl');
  let   block = parseValOrNaN('block');

  if (isNaN(zfw) || isNaN(k) || isNaN(taxi)) {
    alert('Renseigne ZFW, K et Taxi, puis soit RFL soit Block.');
    return;
  }

  hasCalculated = true;

  // K et Taxi figés après premier calcul
  setLocked('k', true);
  setLocked('taxi', true);

  // Cas 1 : RFL donné
  if (!isNaN(rfl)) {
    const law  = zfw + rfl;
    const tow  = law * k;
    const trip = tow - law; // Trip = TOW - LAW [web:221]

    if (isNaN(block)) {
      block = taxi + trip + rfl; // Block = Taxi + Trip + RFL [web:221]
      blockEl.value = block.toFixed(1);
    }

    rflEl.value = rfl.toFixed(1);
    mlwEl.textContent  = fmt1(law);
    mtowEl.textContent = fmt1(tow);
    tripEl.textContent = fmt1(trip);
    return;
  }

  // Cas 2 : Block donné, RFL vide -> on résout RFL
  if (isNaN(rfl) && !isNaN(block)) {
    const rflSolved = (block - taxi - zfw * (k - 1)) / k;
    rfl = rflSolved;
    rflEl.value = rfl.toFixed(1);

    const law  = zfw + rfl;
    const tow  = law * k;
    const trip = tow - law;

    mlwEl.textContent  = fmt1(law);
    mtowEl.textContent = fmt1(tow);
    tripEl.textContent = fmt1(trip);
    return;
  }

  alert('Renseigne soit RFL, soit Block (une seule des deux).');
});

// ----- Limitation TOW -----
// Formule : TOW = ZFW + Block - Taxi [web:236]
function applyTowLimit() {
  const towLimit = parseValOrNaN('towLimit');
  if (isNaN(towLimit)) {
    handleLimitInputClear(towLimEl);
    return;
  }

  const k    = parseValOrNaN('k');
  const taxi = parseValOrNaN('taxi');
  const rfl  = parseValOrNaN('rfl');
  if (isNaN(k) || isNaN(taxi) || isNaN(rfl) || k <= 0) return;

  // 1) LAW_max = TOW_limit / K [web:236]
  const lawMax = towLimit / k;

  // 2) ZFW_max = LAW_max - RFL [web:221]
  let zfwMax = lawMax - rfl;
  if (zfwMax < 0) zfwMax = 0;

  // 3) Block_new pour respecter TOW_limit
  let blockNew = towLimit - zfwMax + taxi;
  if (blockNew < 0) blockNew = 0;

  zfwEl.value   = zfwMax.toFixed(1);
  blockEl.value = blockNew.toFixed(1);

  zfwEl.classList.add('state-limited');
  blockEl.classList.add('state-limited');

  document.getElementById('btnCalc').click();
}

towLimEl.addEventListener('blur', applyTowLimit);
towLimEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    applyTowLimit();
  }
});

// ----- Limitation LAW -----
// Si LAW_limit < LAW_actuelle -> réduction ZFW max + ajustement Block.
// Si LAW_limit > LAW_actuelle -> ZFW inchangé, RFL augmenté, Block ajusté. [web:221][web:236]
function applyLawLimit() {
  const lawLimit = parseValOrNaN('lawLimit');
  if (isNaN(lawLimit)) {
    handleLimitInputClear(lawLimEl);
    return;
  }

  const k    = parseValOrNaN('k');
  const taxi = parseValOrNaN('taxi');
  const rfl  = parseValOrNaN('rfl');
  const zfw  = parseValOrNaN('zfw');
  if (isNaN(k) || isNaN(taxi) || isNaN(rfl) || isNaN(zfw) || k <= 0) return;

  const lawCurrent = zfw + rfl; // LAW_actuelle [web:221]

  let zfwNew   = zfw;
  let rflNew   = rfl;
  let blockNew;

  if (lawLimit < lawCurrent) {
    // Limitation plus faible -> réduction ZFW max
    const towMax = lawLimit * k;      // [web:236]
    let zfwMax   = lawLimit - rfl;    // [web:221]
    if (zfwMax < 0) zfwMax = 0;
    zfwNew = zfwMax;

    blockNew = towMax - zfwMax + taxi;
    if (blockNew < 0) blockNew = 0;

  } else {
    // Limite plus haute -> ZFW inchangé, on augmente RFL + Block
    // LAW_limit = ZFW + RFL_new -> RFL_new = LAW_limit - ZFW [web:221]
    rflNew = lawLimit - zfw;
    if (rflNew < 0) rflNew = 0;

    const towNew = lawLimit * k;      // [web:236]
    blockNew = towNew - zfw + taxi;
    if (blockNew < 0) blockNew = 0;
  }

  zfwEl.value   = zfwNew.toFixed(1);
  rflEl.value   = rflNew.toFixed(1);
  blockEl.value = blockNew.toFixed(1);

  zfwEl.classList.add('state-limited');
  blockEl.classList.add('state-limited');

  document.getElementById('btnCalc').click();
}

lawLimEl.addEventListener('blur', applyLawLimit);
lawLimEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    applyLawLimit();
  }
});

document.getElementById('btnReset').addEventListener('click', function () {
  hasCalculated = false;

  ['zfw','k','taxi','rfl','block','towLimit','lawLimit'].forEach(id => {
    const el = document.getElementById(id);
    el.value = '';
    if (id === 'k' || id === 'taxi') {
      el.readOnly = false;
    }
  });

  zfwEl.className   = 'state-adjust';
  rflEl.className   = 'state-adjust';
  blockEl.className = 'state-adjust';
  kEl.className     = 'state-edit';
  taxiEl.className  = 'state-edit';

  zfwEl.classList.remove('state-limited');
  blockEl.classList.remove('state-limited');

  clearResults();
});

// service worker inchangé
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .catch(err => console.log('SW registration failed', err));
  });
}
</script>
</body>
</html>
